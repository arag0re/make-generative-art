let W,H,rendererW,rendererH,rendererMargin,rendererCorners,margin=64;function setup(){W=Math.min(window.innerWidth,window.innerHeight),H=W;createCanvas(W,H,P2D);initRenderers(),resetAnim(),generate()}let pad_min,pad_max,rect,rendererP5,renderer,color_scheme,seed=0,stroke_width=8,level_min=1,level_max=4,r_subdivide=.45,freqPad=.5,style=null,transform=null,allow_holes=!1,has_shape=!1,styleDefs=[[0,1,2,3],[0,0,0,0],[0,0,1,1],[1,1,1,1],[1,3,3,3],[1,1,2,3],[0,2,3,3],[2,2,3,3],[0,0,0,1],[1,4,4,4],[1,4,5,5]],transformDefs=[[0,1,2,3],[0,0,0,0],[0,1,0,1],[1,2,1,2],[1,2,2,2],[0,0,2,2],[2,2,3,3]],color_schemes=[{id:"cl",name:"Classic",background:"#000000",stroke:"#FFFFFF",fill:"#FFFFFF"},{id:"cc",name:"Classic Coral",background:"#000000",stroke:"#f95341",fill:"#f95341"},{id:"s",name:"Soft",background:"#013a49",stroke:"#FFFFFF",fill:"#FFFFFF"},{id:"cs",name:"Coral Soft",background:"#013a49",stroke:"#f95341",fill:"#f95341"},{id:"cse",name:"Coral Soft Extended",background:"#013a49",stroke:"#f95341",fill:"#ffffff"},{id:"c",name:"Coral",background:"#f95341",stroke:"#FFFFFF",fill:"#FFFFFF"},{id:"e",name:"Electric",background:"#0000d6",stroke:"#FFFFFF",fill:"#FFFFFF"}],animDuration=.75,animDelta=.1,animTime=0,animCenter={x:0,y:0},animDistMax=1,animDir=1,getTimeNorm=function(e){return easeOutSine(constrain((animTime-(e||0))/animDuration,0,1))},resetAnim=function(){animTime=0,animDir*=-1,animDistMax=getDistMaxToCorners(animCenter.x,animCenter.y)},getDistMaxToCorners=function(e,t){let r=0;return rendererCorners.forEach((i=>{r=Math.max(r,dist(e,t,i.x,i.y))})),r};function getStrokeWidth(){let e=rendererW-2*rendererMargin;return e>256?Math.max(4,e/1024*(pad_max<7?8:6)):2}function initParameters(){allow_holes=random_between(0,1)<=.25,level_min=1,level_max=level_min+random_int(1,3),pad_min=level_max-(allow_holes?1:0),pad_max=level_max+3,stroke_width=getStrokeWidth(),r_subdivide=random_between(.1,.4),freqPad=random_between(.25,2),style=styleDefs[random_int(0,styleDefs.length-1)],transform=transformDefs[random_int(0,transformDefs.length-1)],has_shape=random_between(0,1)<=.5;let e=random_int(0,color_schemes.length-1);color_scheme=color_schemes[e]}function initRenderers(){rendererW=pow2(W),rendererH=pow2(H),rendererMargin=64*rendererW/1024,rendererW+=2*rendererMargin,rendererH+=2*rendererMargin,animCenter.x=rendererW/2,animCenter.y=rendererH/2,rendererP5=new RendererP5_Offscreen(rendererW,rendererH,rendererMargin),rendererCorners=[{x:0,y:0},{x:rendererW,y:0},{x:rendererW,y:rendererH},{x:0,y:rendererH}]}function initSeed(){seed=parseInt(tokenData.hash.slice(0,16),16)}function checkDegenerateCase(){let e=!0;return allow_holes&&freqPad>=.5&&freqPad<=1.07&&style.includes(3)&&2==level_max?rect.children.forEach((t=>{3!=style[t.motif]&&(e=!1)})):e=!1,e}function generate(){for(initSeed(),initParameters(),rect=new Cell(null,rendererMargin,rendererMargin,rendererW-2*rendererMargin,rendererH-2*rendererMargin),rect.compute();checkDegenerateCase();)rect.compute()}function draw(){animTime+=deltaTime/1e3,renderer=rendererP5,rendererP5.draw(rect)}function mousePressed(){mouseX>=0&&mouseX<=width&&mouseY>=0&&mouseY<=height&&(animCenter.x=map(mouseX,0,W,0,rendererW),animCenter.y=map(mouseY,0,H,0,rendererH),resetAnim())}class RendererP5_Offscreen{constructor(e,t,r){this.cell=null,this.width=e,this.height=t,this.margin=r,this.patternFunc=[this.drawLinearStripes.bind(this),this.drawCircleStripes.bind(this),this.drawZigZagStripes.bind(this),this.drawSquareStripes.bind(this),this.drawPermutations.bind(this),this.drawDuplo.bind(this)],this.pg=createGraphics(e,t,P2D),this.pg.angleMode(DEGREES),this.pg.strokeCap(ROUND)}getTimeOffset(){let e=dist(animCenter.x,animCenter.y,this.cell.x+.5*this.cell.w,this.cell.y+.5*this.cell.h)/animDistMax;return map(e,0,1,animDir<0?1:0,animDir<0?0:1)}push(){this.pg.push()}pop(){this.pg.pop()}fill(e){this.pg.fill(e)}transformCorner(){1==this.cell.cornerMotif?(this.pg.translate(this.cell.w,0),this.pg.rotate(90)):2==this.cell.cornerMotif?(this.pg.translate(this.cell.w,this.cell.h),this.pg.rotate(180)):3==this.cell.cornerMotif&&(this.pg.translate(0,this.cell.h),this.pg.rotate(-90))}drawRect(e,t,r,i){this.push(),this.pg.translate(e,t),this.pg.beginShape(),this.pg.vertex(0,0),vertex(r,0),this.pg.vertex(r,i),this.pg.vertex(0,i),this.pg.endShape(CLOSE),this.pg.pop()}drawCell(e){this.cell=e,this.pg.push(),this.pg.translate(e.x,e.y),this.pg.push(),this.transformCorner(),this.patternFunc[style[this.cell.motif]](e.pad),this.pg.pop(),this.pg.pop()}draw(e){this.pg.background(color_scheme.background),this.pg.noFill(),this.pg.stroke(color_scheme.stroke),this.pg.strokeWeight(stroke_width),e.draw(),image(this.pg,0,0,W,H)}drawZigZagStripes(e){let t=[],r=this.cell.w;for(let i=0,n=0;i<=this.cell.h;i+=e,n++)t.push({x:n%2==0?0:r,y:i}),t.push({x:n%2==0?r:0,y:i});this.drawPolylineA(t,{tOffset:this.getTimeOffset()})}drawLinearStripes(e){let t=this.getTimeOffset();for(let r=0,i=0;r<=this.cell.h;r+=e,i++)this.lineA(0,r,this.cell.w,r,{index:i,tOffset:t})}drawLinearStripes2(e){let t=this.getTimeOffset();for(let r=0,i=0;r<=this.cell.w;r+=e,i++)this.lineA(r,0,r,this.cell.h,{index:i,tOffset:t})}drawCircleStripes(e){let t,r=this.cell.w,i=0,n=Math.sqrt(2)*r,s=0,l=0,h=this.getTimeOffset();for(;i<n;){if(i<=r)t=0,s=90;else{let e=Math.sqrt(i*i-r*r),n=r,l=e,h=e,a=r;t=this.pg.atan2(l,n),s=this.pg.atan2(a,h)}i>0&&this.arcA(0,0,2*i,2*i,t,s,{index:l++,tOffset:h}),i+=e}}drawSquareStripes(e){let t=this.getTimeOffset(),r=[],i=e;for(;i<=this.cell.w;)r.push([{x:i,y:0},{x:i,y:i},{x:0,y:i}]),i+=e;for(let e=0;e<r.length;e++)this.drawPolylineA(r[e],{index:e,nb:r.length,tOffset:t})}drawPermutations(e){if(this.cell.polylines){let t=this.getTimeOffset(),r=this.cell.polylines;for(let i=0;i<r.length;i++)this.drawPolylineA(r[i].map((t=>({x:t.x*e,y:t.y*e}))),{index:i,nb:r.length,tOffset:t+this.cell.polylinesTimeOffset[i]})}else this.drawSquareStripes(e)}drawShortLines(e,t,r,i,n){if("v"==e)for(let e=n;e<=this.cell.w-n;e+=i)this.lineA(e,t,e,r);else if("h"==e)for(let e=n;e<=this.cell.h-n;e+=i)this.lineA(t,e,r,e)}drawDuplo(e){if(int(this.cell.h/e)>=8){let t=e*this.cell.duploRndMargin;this.drawShortLines("v",t,0,e,t),this.drawShortLines("v",this.cell.h-t,this.cell.h,e,t),this.drawShortLines("h",t,0,e,t),this.drawShortLines("h",this.cell.w-t,this.cell.w,e,t),this.push(),this.fill(color_scheme.fill),this.drawRect(t,t,this.cell.w-2*t,this.cell.h-2*t),this.pop()}else{let t=this.cell.duploRndMotif;0==t?(this.drawLinearStripes(e),this.drawLinearStripes2(e)):1==t?this.drawLinearStripes(e):this.drawLinearStripes2(e)}}lineA(e,t,r,i,n){let s=(n||{}).tOffset||0,l=getTimeNorm(s);if(l>.05){let n=createVector(e,t),s=createVector(r,i),h=p5.Vector.lerp(n,s,l);this.pg.line(n.x,n.y,h.x,h.y)}}arcA(e,t,r,i,n,s,l){let h=l||{},a=h.tOffset||0,o=h.index||0,d=getTimeNorm(a+o*animDelta);d>.05&&this.pg.arc(e,t,r,i,n,lerp(n,s,d))}drawPolylineA(e,t){let r=t||{},i=r.tOffset||0,n=r.index||0;drawPolyline(this.pg,e,getTimeNorm(i+n*animDelta))}}function random_hash(){let e="0123456789abcdef",t="0x";for(let r=64;r>0;--r)t+=e[Math.floor(Math.random()*e.length)];return t}function random_dec(){return seed^=seed<<13,seed^=seed>>17,seed^=seed<<5,(seed<0?1+~seed:seed)%1e3/1e3}function random_between(e,t){return e+(t-e)*this.random_dec()}function random_int(e,t){return Math.floor(this.random_between(e,t+1))}class Cell{constructor(e,t,r,i,n){this.level=e?e.level+1:0,this.x=t||0,this.y=r||0,this.w=i||width,this.h=n||height,this.pad=0,this.steps=0,this.motif=0,this.cornerMotif=0,this.children=null}getMotifIndex(){return random_int(0,style.length-1)}compute(){if((this.level<level_min?1:random_dec())>=r_subdivide&&this.level<level_max){let e=.5*this.w;this.children=[],this.children[0]=new Cell(this,this.x,this.y,e,e),this.children[1]=new Cell(this,this.x+e,this.y,e,e),this.children[2]=new Cell(this,this.x+e,this.y+e,e,e),this.children[3]=new Cell(this,this.x,this.y+e,e,e),this.children.forEach((e=>e.compute()))}else this.motif=this.getMotifIndex(),this.cornerMotif=transform[random_int(0,3)],this.computePad(),4==style[this.motif]?this.computePermutations():5==style[this.motif]&&(this.duploRndMargin=random_int(1,3),this.duploRndMotifOther=random_int(0,2));return this}computePermutations(){let e=int(this.h/this.pad)+1;if(e>=5){let t=new Array,r=Array(e);for(let t=0;t<e;t++)r[t]=t;t=Array();let i=[...r];for(let r=0;r<e;r++)r>0&&i.permute(),t.push([...i]);let n=t,s=n.length;this.polylines=Array(n.length),this.polylinesTimeOffset=Array(n.length);for(let e=0;e<s;e++)this.polylines[e]=Array(),this.polylinesTimeOffset[e]=random_between(0,.65);let l=0;for(let e=0;e<s;e++){let t=n[e];for(let e=0;e<s;e++)this.polylines[e].push({x:l,y:t.indexOf(e)});l+=1}}}computePad(){let e=this.x+.5*this.w,t=this.y+.5*this.h,r=map(dist(e,t,rendererW/2,rendererH/2),0,rendererW/2,0,1),i=0|map(Math.cos(freqPad*r*2*Math.PI),-1,1,pad_min,pad_max);this.steps=Math.pow(2,i),this.pad=(rendererW-2*rendererMargin)/this.steps}draw(){this.children?this.children.forEach((e=>e.draw())):renderer&&renderer.drawCell(this)}}function easeOutSine(e){return Math.sin(e*Math.PI/2)}function pow2(e){if(e<=0)return 0;let t=1;for(;t<e;)t<<=1;return t}function getPolylineLength(e){let t=0;if(e.length>=2){let r,i=e[0];for(let n=0;n<e.length-1;n++)r=e[n+1],t+=dist(i.x,i.y,r.x,r.y),i=r}return t}function drawPolyline(e,t,r){if(void 0===r&&(r=1),r<=0)return;r>=.99&&(r=1);let i,n=getPolylineLength(t),s=t[0],l={x:0,y:0},h=0,a=0,o=r*n,d=0;for(let r=0;r<t.length-1;r++){if(i=t[r+1],h=dist(s.x,s.y,i.x,i.y),o>=a&&o<a+h){d=(o-a)/h,l.x=lerp(s.x,i.x,d),l.y=lerp(s.y,i.y,d),e?e.line(s.x,s.y,l.x,l.y):line(s.x,s.y,l.x,l.y);break}e?e.line(s.x,s.y,i.x,i.y):line(s.x,s.y,i.x,i.y),a+=h,s=i}}function transformAsStr(e){return 0==e?"0째":1==e?"90째":2==e?"180째":3==e?"270째":void 0}function motifAsStr(e){return 0==e?"linear":1==e?"arc":2==e?"zigzag":3==e?"square":4==e?"permutation":5==e?"duplo":"?"}Array.prototype.permute=function(e){e=e||-1;let t=random_int(0,this.length-2);for(;t==e;)t=random_int(0,this.length-2);let r=this[t];return this[t]=this[t+1],this[t+1]=r,t};